@using Realtair.Framework.Core.Web.Utilities
@model Realtair.Framework.Core.Web.Controllers.EnquiryController.EnquiryViewModel
@using Realtair.Framework.Enquiries.Entities;

@Html.Partial("Menu")

<div id="page-wrapper" class="with-background">
    <div class="container">
        <!-- .chat-row -->
        <div class="chat-main-box">
            <!-- .chat-left-panel -->
            <div class="chat-left-aside">
                <div class="open-panel"><i class="ti-angle-right"></i></div>
                <div class="chat-left-inner">
                    <div class="form-material">
                        <input class="form-control p-20" type="text" placeholder="Search Contact">
                    </div>
                    <ul class="chatonline style-none ">
                        @foreach (var user in Model.Conversation.Users.Where(u => u != Html.LoggedInUser()))
                        {
                            <li>
                                <a href="javascript:void(0)"><img src="http://static.realtair.com/plugins/images/users/varun.jpg" alt="user-img" class="img-circle"> <span>@user.Person.Name<small class="text-success">@user.RoleType</small></span></a>
                            </li>
                        }
                        <li class="p-20"></li>
                        <li class="divider"></li>
                        <li class="box-label">Other conversations (@Model.Conversations.Where(c => c != Model.Conversation).Count())</li>
                        @foreach (var user in Model.Conversation.Users.Where(u => u != Html.LoggedInUser()))
                        {
                            <li>
                                <a href="javascript:void(0)"><img src="http://static.realtair.com/plugins/images/users/varun.jpg" alt="user-img" class="img-circle"> <span>@user.Person.Name<small class="text-success">@user.RoleType</small></span></a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
            <!-- .chat-left-panel -->
            <!-- .chat-right-panel -->
            <div class="chat-right-aside">
                <div class="chat-main-header hidden-xs">
                    <div class="p-20 b-b">
                        <h3 class="box-title">Chat Message</h3>
                    </div>
                </div>
                <div class="chat-box">
                    <div class="messagebox">
                        @Html.Partial("Timeline", Model.Timeline)
                    </div>
                    <div class="row send-chat-box">
                        <div class="col-sm-12">
                            @foreach (var action in Model.Workflow.Extension.Actions().WithAccess(Html.LoggedInUser(), ViewContext.DbContext()).Take(3).Reverse())
                            {
                                <form class="inline" action="@action.GetUrl(Url)" method="@(action.Fields.Count() >= 1 ? "GET" : "POST")">
                                    <input name="ReturnUrl" type="hidden" value="@Request.Url.AbsolutePath" />
                                    <button class="btn btn-default pull-right" type="submit">@action.Description(Html.LoggedInUser())</button>
                                </form>
                            }
                        </div>
                        <div class="col-sm-12">
                            <textarea class="form-control chat-box" placeholder="Type your message" name="messageText"></textarea>
                            <div class="custom-send">
                                <a href="javacript:void(0)" class="cst-icon" data-toggle="tooltip" title="Insert Emojis"><i class="ti-face-smile"></i></a>
                                <a href="javacript:void(0)" class="cst-icon" data-toggle="tooltip" title="File Attachment"><i class="fa fa-paperclip"></i></a>
                                <button type="submit" class="btn btn-danger btn-rounded">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- .chat-right-panel -->
        </div>
        <!-- /.chat-row -->
        <!-- ============================================================== -->
        <!-- Right sidebar -->
        <!-- ============================================================== -->
        <!-- .right-sidebar -->
        <div class="right-sidebar">
            <div class="slimscrollright">
                <div class="rpanel-title"> Service Panel <span><i class="ti-close right-side-toggle"></i></span> </div>
                <div class="r-panel-body">
                    <ul id="themecolors" class="m-t-20">
                        <li><b>With Light sidebar</b></li>
                        <li><a href="javascript:void(0)" data-theme="default" class="default-theme">1</a></li>
                        <li><a href="javascript:void(0)" data-theme="green" class="green-theme">2</a></li>
                        <li><a href="javascript:void(0)" data-theme="gray" class="yellow-theme">3</a></li>
                        <li><a href="javascript:void(0)" data-theme="blue" class="blue-theme">4</a></li>
                        <li><a href="javascript:void(0)" data-theme="purple" class="purple-theme">5</a></li>
                        <li><a href="javascript:void(0)" data-theme="megna" class="megna-theme">6</a></li>
                        <li><b>With Dark sidebar</b></li>
                        <br />
                        <li><a href="javascript:void(0)" data-theme="default-dark" class="default-dark-theme">7</a></li>
                        <li><a href="javascript:void(0)" data-theme="green-dark" class="green-dark-theme">8</a></li>
                        <li><a href="javascript:void(0)" data-theme="gray-dark" class="yellow-dark-theme">9</a></li>
                        <li><a href="javascript:void(0)" data-theme="blue-dark" class="blue-dark-theme">10</a></li>
                        <li><a href="javascript:void(0)" data-theme="purple-dark" class="purple-dark-theme">11</a></li>
                        <li><a href="javascript:void(0)" data-theme="megna-dark" class="megna-dark-theme working">12</a></li>
                    </ul>
                    <ul class="m-t-20 all-demos">
                        <li><b>Choose other demos</b></li>
                    </ul>
                    <ul class="m-t-20 chatonline">
                        <li><b>Chat option</b></li>
                        <li>
                            <a href="javascript:void(0)"><img src="../plugins/images/users/varun.jpg" alt="user-img" class="img-circle"> <span>Varun Dhavan <small class="text-success">online</small></span></a>
                        </li>
                        <li>
                            <a href="javascript:void(0)"><img src="../plugins/images/users/genu.jpg" alt="user-img" class="img-circle"> <span>Genelia Deshmukh <small class="text-warning">Away</small></span></a>
                        </li>
                        <li>
                            <a href="javascript:void(0)"><img src="../plugins/images/users/ritesh.jpg" alt="user-img" class="img-circle"> <span>Ritesh Deshmukh <small class="text-danger">Busy</small></span></a>
                        </li>
                        <li>
                            <a href="javascript:void(0)"><img src="../plugins/images/users/arijit.jpg" alt="user-img" class="img-circle"> <span>Arijit Sinh <small class="text-muted">Offline</small></span></a>
                        </li>
                        <li>
                            <a href="javascript:void(0)"><img src="../plugins/images/users/govinda.jpg" alt="user-img" class="img-circle"> <span>Govinda Star <small class="text-success">online</small></span></a>
                        </li>
                        <li>
                            <a href="javascript:void(0)"><img src="../plugins/images/users/hritik.jpg" alt="user-img" class="img-circle"> <span>John Abraham<small class="text-success">online</small></span></a>
                        </li>
                        <li>
                            <a href="javascript:void(0)"><img src="../plugins/images/users/john.jpg" alt="user-img" class="img-circle"> <span>Hritik Roshan<small class="text-success">online</small></span></a>
                        </li>
                        <li>
                            <a href="javascript:void(0)"><img src="../plugins/images/users/pawandeep.jpg" alt="user-img" class="img-circle"> <span>Pwandeep rajan <small class="text-success">online</small></span></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- ============================================================== -->
        <!-- End Right sidebar -->
        <!-- ============================================================== -->
    </div>
    <!-- /.container-fluid -->
    <footer class="footer text-center hidden-xs"> Powered by Realtair</footer>
</div>
<!-- /#page-wrapper -->

@section Scripts {
    <script src="http://static.realtair.com/js/chat.js"></script>
    <script>
        var tempSentMessageId = 0;
        var pollTime = 1000 * 10;

        $(function () {
            $(document).scrollTop($(document).height());
            //setTimeout(doPoll, pollTime);

            $('#send-message-form').submit(function (e) {
                e.preventDefault();
                sendMessage();
            });

            $('.icon-PaperClip').parent().click(function () {
                $('#attachments').trigger('click');
                $('.file-attachment').show();
            });

            //$('.file-attachment').hide();

            $('.close-file').click(function () {
                if ($("#send-message-form .file-attachment .preview").length == 0) $('.file-attachment').hide();
            });

            $('#selectPhotosBtn').click(function () {
                $('#modal-attachments').find('.picked').each(function () {
                    var image = $(this).find('img').attr('src');
                    var storageguid = $(this).find('img').attr('storageguid');
                    $('.file-attachment-thumbnails').append($('<div class="existing-preview" storageguid="' + storageguid + '" style="background-image: url(' + image + ')"><a class="close-file"><i class="fa fa-times"></i></a><input type="hidden" name="existingAttachments" value="' + storageguid + '"></div>'));
                    $('.file-attachment, .file-attachment-thumbnails').show();
                    $(this).toggleClass("picked");

                    $('.existing-preview').each(function () {
                        var $this = $(this);
                        $(this).find('a.close-file').click(function () { $this.remove(); });
                    });
                });
            });

            /* Auto popup gallery */
            var url = window.location.href;
            var hash = url.substring(url.indexOf('#') + 1);
            var queries = hash.split("&");
            for (var i = 0; i < queries.length; i++) {
                if (queries[i].includes("pid")) {
                    var pid = queries[i].split("=")[1];
                    $('#' + pid).trigger('click');
                }
            }

            var textarea = document.querySelector('textarea[name=messageText]');
            textarea.addEventListener('keydown', autosize);

            function autosize() {
                var el = this;
                setTimeout(function () {
                    el.style.cssText = 'height:auto; padding:0';
                    // for box-sizing other than "content-box" use:
                    // el.style.cssText = '-moz-box-sizing:content-box';
                    el.style.cssText = 'height:' + el.scrollHeight + 'px';
                }, 0);
            }
        });

        function sendMessage() {
            tempSentMessageId++;

            var messageId = "sent-" + tempSentMessageId;
            var messageText = $('#send-message-form textarea[name=messageText]').val();
            var attachments = $("#send-message-form .file-attachment .preview");
            var existingAttachments = $("#send-message-form .file-attachment .existing-preview");
            var formToSubmit = $("#send-message-form").serialize();

            $('textarea[name=messageText]').val('');
            $('textarea[name=messageText]').css('height', '60px');
            $('.file-attachment-thumbnails').empty().hide();
            $('#file-attachment').hide();

            if (attachments.length > 0 || jQuery.trim(messageText).length > 0 || existingAttachments.length > 0) {
                var message = $(
                    '<div id="' + messageId + '"class="row row-no-gutter answer message-provider sending">' +
                        '<div class="col-md-5 col-md-push-7">' +
                        '<figure>' +
                            '<span class="img-circle">@(Html.LoggedInUser().Person.FirstName[0])@(Html.LoggedInUser().Person.LastName[0])</span>' +
                        '</figure>' +
                        '<div class="inner-content">' +
                            '<time><span>Now<span></span></span></time>' +
                            '<div class="clearfix"></div>' +
                            '<div class="panel panel-default">' +
                                '<div class="panel-body">' +
                                     messageText +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="col-md-2"><div class="circle-timeline"></div></div>' +
                    '</div>');

                if (attachments.length > 0 || existingAttachments.length > 0) {
                    var attachmentHtml = '<div class="file-attachment text-center">';

                    for (var i = 0; i < attachments.length; i++) {
                        attachmentHtml += '<div class="spin-icon-box"><span class="icon icon-Restart spinner"></span></div>';
                    }

                    for (var i = 0; i < existingAttachments.length; i++) {
                        attachmentHtml += '<div class="spin-icon-box"><span class="icon icon-Restart spinner"></span></div>';
                    }

                    attachmentHtml += "</div>";
                    message.find(".panel").append('<div class="panel-footer"></div>').find(".panel-footer").append(attachmentHtml);
                }

                var baseMainHeight = $(document).height();
                $(".messagebox").append(message);
                $('html,body').animate({ scrollTop: $(document).scrollTop() + $(document).height() - baseMainHeight }, "fast");

                $.ajax({
                    url: '/enquiry/@Model.Workflow.Id/chat/@Model.Conversation.Id/send-message',
                    type: "POST",
                    data: formToSubmit,
                    enctype: 'multipart/form-data',
                    success: function (insertedId) {
                        doPoll();
                        $("#" + messageId).remove();
                    },
                    error: function (data) {
                        window.location.href = "/";
                    }
                });

            }
        }

        function doPoll() {
            $.ajax({
                url: '/enquiry/@Model.Workflow.Id/chat/@Model.Conversation.Id/get-updated-timeline?isActive=' + true,
                type: 'GET',
                success: function (data) {

                    var baseMainHeight = $(document).height();

                    $('.messagebox').children().not('.sending').remove();
                    $(".messagebox").prepend(data);

                    /*$('html,body').animate({
                        scrollTop: $(document).scrollTop() + $(document).height() - baseMainHeight
                    }, "fast");*/

                    setTimeout(doPoll, pollTime);
                },
                error: function (data) {
                    window.location.href = "/";
                }
            });
        }
    </script>
}